---
- name: Docker user bash config and completion
  become: true
  become_user: "{{ docker_user }}"
  block:
    - name: Add .bash_completion script
      ansible.builtin.copy:
        src: bash_completion
        dest: "{{ docker_user_info.home }}/.bash_completion"
        owner: "{{ docker_user }}"
        group: "{{ docker_user }}"
        mode: "0750"

    - name: Create user bash completion dir
      ansible.builtin.file:
        path: "{{ docker_user_info.home }}/.bash_completion.d"
        state: directory
        owner: "{{ docker_user }}"
        group: "{{ docker_user }}"
        mode: "0750"

    - name: Install docker bash completion
      ansible.builtin.get_url:
        url: https://raw.githubusercontent.com/docker/cli/master/contrib/completion/bash/docker
        dest: "{{ docker_user_info.home }}/.bash_completion.d/"
        checksum: sha256:{{ docker_bash_completion_shasum }}
        mode: "0644"

    - name: Extend Docker user bashrc config
      ansible.builtin.blockinfile:
        path: "{{ docker_user_info.home }}/.bashrc"
        owner: "{{ docker_user }}"
        group: "{{ docker_user }}"
        mode: "0644"
        block: |
          export XDG_RUNTIME_DIR="/run/user/{{ docker_user_info.uid }}"
          export DOCKER_HOST="unix:///run/user/{{ docker_user_info.uid }}/docker.sock"
          export PATH="{{ docker_user_info.home }}/bin:{{ docker_user_info.home }}/.local/bin:$PATH"
